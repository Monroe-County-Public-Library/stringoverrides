<?php
// $Id$

/**
 * Implementation of hook_help()
 */
function stringoverrides_help($path, $arg) {
  $output = '';
  switch ($path) {
    case 'admin/help#stringoverrides':
      $output = '<p>'.  t("The String Overrides module provides a quick and easy way of replacing text.") .'</p>';
      break;
    case 'admin/settings/stringoverrides':
      $output = '<p>'.  t("The following provides quick and easy way of replacing text.") .'</p>';
      break;
  }
  return $output;
} // function stringoverrides_help

/**
 * Implementation of hook_menu()
 */
function stringoverrides_menu() {
  $items = array();
  $items['admin/settings/stringoverrides'] = array(
    'title' => 'String overrides',
    'description' => 'Provides a quick and easy way of replacing text on the site.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stringoverrides_admin'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/settings/stringoverrides/js'] = array(
    'title' => 'String Overrides Javascript',
    'page callback' => 'stringoverrides_js',
    'type' => MENU_CALLBACK,
  );
  return $items;
} // function stringoverrides_menu

/**
 * Implementation of hook_init()
 */
function stringoverrides_init() {
  global $conf;
  $strings = _stringoverrides_get_overrides();
  $conf['locale_custom_strings_en'] = $strings;
} // function hook_init()

/**
 * Gets all enabled string overrides
 */ 
function _stringoverrides_get_overrides() {
  static $stringoverrides = NULL;
  if ($stringoverrides === NULL) {
    $stringoverrides = cache_get('stringoverrides');
    if ($stringoverrides) {
      $stringoverrides = $stringoverrides->data;
    }
    else {
      $stringoverrides = array();
      $result = db_query('SELECT original, replacement FROM {stringoverrides} WHERE enabled = %d', 1);
      while ($string = db_fetch_object($result)) {
        $stringoverrides[$string->original] = $string->replacement;
      }
      cache_set('stringoverrides', $stringoverrides);
    }
  }
  return $stringoverrides;
}

/**
 * Implementation of hook_theme()
 */
function stringoverrides_theme() {
  return array(
    'stringoverrides_strings' => array(
      'arguments' => array('form' => NULL),
    ),
  );
} // function hook_theme()

/**
 * Menu callback for the String Overrides module to display its administration
 */
function stringoverrides_admin() {
  $form['stringoverrides_wrapper'] = array(
    '#tree' => FALSE,
    '#weight' => -4,
    '#prefix' => '<div id="stringoverrides-wrapper">',
    '#suffix' => '</div>',
  );
  $form['stringoverrides_wrapper']['string'] = array(
    '#type' => 'markup',
    '#prefix' => '<div id="stringoverrides-wrapper-string">',
    '#suffix' => '</div>',
    '#theme' => 'stringoverrides_strings',
  );
  
  $delta = 0;
  $result = db_query("SELECT enabled, original, replacement FROM {stringoverrides} ORDER BY original");
  while ($string = db_fetch_object($result)) {
    $form['stringoverrides_wrapper']['string'][$delta] = stringoverrides_textbox_combo($delta, $string->enabled, $string->original, $string->replacement);
    $delta++;
  }
  for ($index = 0; $index < 2; $index++) {
    $form['stringoverrides_wrapper']['string'][$delta] = stringoverrides_textbox_combo($delta);
    $delta++;
  }
  
  //for ($delta = 0; $delta < 3; $delta++) {
    $form['stringoverrides_wrapper']['string'][$delta] = stringoverrides_textbox_combo($delta);
  //}
  $form['stringoverrides_wrapper']['more_strings'] = array(
    '#type' => 'submit',
    '#value' => t('More strings'),
    '#description' => t("If the amount of boxes above isn't enough, click here to add more choices."),
    '#submit' => array('stringoverrides_more_strings_submit'), // If no javascript action.
    '#weight' => 2,
    '#ahah' => array(
      'path' => 'admin/settings/stringoverrides/js',
      'wrapper' => 'stringoverrides-wrapper-string',
      'method' => 'append',
      'effect' => 'fade',
      'event' => 'click',
    ),
  );
  $form['stringoverrides_wrapper']['save'] = array(
    '#type' => 'submit',
    '#value' => t('Save configuration'),
    '#weight' => 3,
  );
  return $form;
} // function stringoverrides_admin

/**
 * Triggered when the user submits the administration page
 */ 
function stringoverrides_admin_submit($form, &$form_state) {
  // Remove old values
  db_query('DELETE FROM {stringoverrides}');
  cache_clear_all('stringoverrides', 'cache');
  
  // Add all new values
  foreach ($form_state['values']['string'] as $index => $value) {
    if (!empty($value->original)) {
      db_query('INSERT INTO {stringoverrides} (enabled, original, replacement) VALUES (%d, "%s", "%s")', $value['enabled'], $value['original'], $value['replacement']);
    }
  }
  
  // Output a message to the user
  drupal_set_message('Your changes have been saved.');
} // function stringoverrides_admin_submit()

/**
 * Triggered when the user clicks "More strings" and doesn't have javascript
 */ 
function stringoverrides_more_strings_submit($form, &$form_state) {
  // Save the values
  stringoverrides_admin_submit($form, $form_state);

  // Tell it to create more form elements
  if ($form_state['values']['more_strings']) {
    $form_state['string_count'] = count($form_state['values']['choice']) + 5;
  }
} // function stringoverrides_more_strings_submit()

/**
 * Function to return a textbox combo form
 */ 
function stringoverrides_textbox_combo($delta = 0, $enabled = TRUE, $original = '', $replacement = '') {
  $form = array(
    '#tree' => TRUE,
  );
  $form['enabled'] = array(
    '#type' => 'checkbox', 
    '#default_value' => $enabled,
    '#parents' => array('string', $delta, 'enabled'),
  );
  $form['original'] = array(
    '#type' => 'textfield',
    '#default_value' => $original,
    '#size' => 30,
    '#parents' => array('string', $delta, 'original'),
  );
  $form['replacement'] = array(
    '#type' => 'textfield',
    '#default_value' => $replacement,
    '#size' => 30,
    '#parents' => array('string', $delta, 'replacement'),
  );
  return $form;
} // function stringoverrides_textbox_combo()

/**
 * Theme the enabled box and the two text box strings
 */
function theme_stringoverrides_strings($form) {
  $headers = array(
    theme('table_select_header_cell'),
    t('Original'),
    t('Replacement'),
  );
  $rows = array();
  foreach (element_children($form) as $key) {
    // Build the table row.
    $rows[] = array(
      'data' => array(
        array('data' => drupal_render($form[$key]['enabled']), 'class' => 'stringoverrides-enabled'),
        array('data' => drupal_render($form[$key]['original']), 'class' => 'stringoverrides-original'),
        array('data' => drupal_render($form[$key]['replacement']), 'class' => 'stringoverrides-replacement'),
      ),
    );
  }
  $output = theme('table', $headers, $rows);
  $output .= drupal_render($form);
  return $output;
} // function theme_stringoverrides_strings()

/**
 * Menu callback for the String Overrides module to display a new string override
 */
function stringoverrides_js() {
  $delta = count($_POST['string']);
  
  $form_state = array('submitted' => FALSE);
  $form[$delta] = stringoverrides_textbox_combo($delta);
  $form['#post'] = $_POST;
  $form['#programmed'] = FALSE;
  
  $form = form_builder('stringoverrides_form', $form, $form_state);
  $data = drupal_render($form);
  drupal_json(array('status' => TRUE, 'data' => $data));
} // function stringoverrides_js()
